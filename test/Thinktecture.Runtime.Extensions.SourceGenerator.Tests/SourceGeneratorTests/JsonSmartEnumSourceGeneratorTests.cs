using Thinktecture.CodeAnalysis.SmartEnums;
using Xunit.Abstractions;

namespace Thinktecture.Runtime.Tests.SourceGeneratorTests;

public class JsonSmartEnumSourceGeneratorTests : SourceGeneratorTestsBase
{
   public JsonSmartEnumSourceGeneratorTests(ITestOutputHelper output)
      : base(output)
   {
   }

   [Fact]
   public void Should_generate_JsonConverter_and_Attribute_if_Attribute_is_missing()
   {
      var source = """

                   using System;

                   namespace Thinktecture.Tests
                   {
                      [SmartEnum<string>]
                   	public partial class TestEnum
                   	{
                         public static readonly TestEnum Item1 = new("Item1");
                         public static readonly TestEnum Item2 = new("Item2");
                      }
                   }

                   """;
      var output = GetGeneratedOutput<SmartEnumSourceGenerator>(source,
                                                                ".Json",
                                                                typeof(IEnum<>).Assembly, typeof(Thinktecture.Text.Json.Serialization.ValueObjectJsonConverter<,,>).Assembly, typeof(System.Text.Json.JsonDocument).Assembly);

      AssertOutput(output, """
                           // <auto-generated />
                           #nullable enable

                           namespace Thinktecture.Tests;

                           [global::System.Text.Json.Serialization.JsonConverterAttribute(typeof(global::Thinktecture.Text.Json.Serialization.ValueObjectJsonConverterFactory<global::Thinktecture.Tests.TestEnum, global::Thinktecture.ValidationError>))]
                           partial class TestEnum
                           {
                           }

                           """);
   }

   [Fact]
   public void Should_generate_JsonConverter_for_enum_without_namespace()
   {
      var source = """

                   using System;
                   using Thinktecture;

                   [SmartEnum<string>]
                   public partial class TestEnum
                   {
                      public static readonly TestEnum Item1 = new("Item1");
                      public static readonly TestEnum Item2 = new("Item2");
                   }

                   """;
      var output = GetGeneratedOutput<SmartEnumSourceGenerator>(source,
                                                                ".Json",
                                                                typeof(IEnum<>).Assembly, typeof(Thinktecture.Text.Json.Serialization.ValueObjectJsonConverter<,,>).Assembly, typeof(System.Text.Json.JsonDocument).Assembly);

      AssertOutput(output, """
                           // <auto-generated />
                           #nullable enable

                           [global::System.Text.Json.Serialization.JsonConverterAttribute(typeof(global::Thinktecture.Text.Json.Serialization.ValueObjectJsonConverterFactory<global::TestEnum, global::Thinktecture.ValidationError>))]
                           partial class TestEnum
                           {
                           }

                           """);
   }

   [Fact]
   public void Should_generate_JsonConverter_and_Attribute_for_struct_if_Attribute_is_missing()
   {
      var source = """

                   using System;

                   namespace Thinktecture.Tests
                   {
                      [SmartEnum<string>]
                   	public partial struct TestEnum
                   	{
                         public static readonly TestEnum Item1 = new("Item1");
                         public static readonly TestEnum Item2 = new("Item2");
                      }
                   }

                   """;
      var output = GetGeneratedOutput<SmartEnumSourceGenerator>(source,
                                                                ".Json",
                                                                typeof(IEnum<>).Assembly, typeof(Thinktecture.Text.Json.Serialization.ValueObjectJsonConverter<,,>).Assembly, typeof(System.Text.Json.JsonDocument).Assembly);

      AssertOutput(output, """
                           // <auto-generated />
                           #nullable enable

                           namespace Thinktecture.Tests;

                           [global::System.Text.Json.Serialization.JsonConverterAttribute(typeof(global::Thinktecture.Text.Json.Serialization.ValueObjectJsonConverterFactory<global::Thinktecture.Tests.TestEnum, global::Thinktecture.ValidationError>))]
                           partial struct TestEnum
                           {
                           }

                           """);
   }

   [Fact]
   public void Should_not_generate_JsonConverter_and_attribute_if_Attribute_is_present()
   {
      var source = """

                   using System;
                   using System.Text.Json.Serialization;

                   namespace Thinktecture.Tests
                   {
                      public class TestEnumJsonConverter : Thinktecture.Text.Json.Serialization.EnumJsonConverter<TestEnum, string>
                      {
                         public TestEnum_EnumJsonConverter()
                            : this(null)
                         {
                         }

                         public TestEnum_EnumJsonConverter(
                            JsonConverter<string>? keyConverter)
                            : base(TestEnum.Get, keyConverter)
                         {
                         }
                      }

                      [SmartEnum<string>]
                      [JsonConverter(typeof(TestEnumJsonConverter))]
                   	public partial class TestEnum
                   	{
                         public static readonly TestEnum Item1 = new("Item1");
                         public static readonly TestEnum Item2 = new("Item2");
                      }
                   }

                   """;
      var output = GetGeneratedOutput<SmartEnumSourceGenerator>(source,
                                                                ".Json",
                                                                typeof(IEnum<>).Assembly, typeof(Thinktecture.Text.Json.Serialization.ValueObjectJsonConverter<,,>).Assembly, typeof(System.Text.Json.JsonDocument).Assembly);

      output.Should().BeNull();
   }

   [Fact]
   public void Should_not_generate_JsonConverter_for_keyless_enum()
   {
      var source = """

                   using System;

                   namespace Thinktecture.Tests
                   {
                      [SmartEnum]
                   	public partial class TestEnum
                   	{
                         public static readonly TestEnum Item1 = new("Item1");
                         public static readonly TestEnum Item2 = new("Item2");
                      }
                   }

                   """;
      var output = GetGeneratedOutput<SmartEnumSourceGenerator>(source,
                                                                ".Json",
                                                                typeof(IEnum<>).Assembly, typeof(Thinktecture.Text.Json.Serialization.ValueObjectJsonConverter<,,>).Assembly, typeof(System.Text.Json.JsonDocument).Assembly);

      output.Should().BeNull();
   }
}
