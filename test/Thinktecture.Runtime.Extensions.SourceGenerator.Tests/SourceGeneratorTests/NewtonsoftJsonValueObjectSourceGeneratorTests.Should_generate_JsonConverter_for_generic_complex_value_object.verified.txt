// <auto-generated />
#nullable enable

namespace Thinktecture.Tests;

[global::Newtonsoft.Json.JsonConverterAttribute(typeof(ValueObjectNewtonsoftJsonConverterFactory))]
partial class ComplexValueObject<T1, T2, T3>
{
   /// <summary>
   /// JSON converter for <c>ComplexValueObject&lt;T1, T2, T3&gt;</c>.
   /// </summary>
   public sealed class ValueObjectNewtonsoftJsonConverter : global::Newtonsoft.Json.JsonConverter
   {
      private static readonly global::System.Type _type = typeof(global::Thinktecture.Tests.ComplexValueObject<T1, T2, T3>);

      /// <inheritdoc />
      public override bool CanConvert(global::System.Type objectType)
      {
         return _type == objectType;
      }

      /// <inheritdoc />
      public override object? ReadJson(global::Newtonsoft.Json.JsonReader reader, global::System.Type objectType, object? existingValue, global::Newtonsoft.Json.JsonSerializer serializer)
      {
         if (reader is null)
            throw new global::System.ArgumentNullException(nameof(reader));
         if (serializer is null)
            throw new global::System.ArgumentNullException(nameof(serializer));

         if (reader.TokenType == global::Newtonsoft.Json.JsonToken.Null)
         {
            if(global::System.Nullable.GetUnderlyingType(objectType) == _type)
               return null;

            var (lineNumber, linePosition) = GetLineInfo(reader);

            return default(global::Thinktecture.Tests.ComplexValueObject<T1, T2, T3>);
         }

         if (reader.TokenType != global::Newtonsoft.Json.JsonToken.StartObject)
         {
            var (lineNumber, linePosition) = GetLineInfo(reader);

            throw new global::Newtonsoft.Json.JsonReaderException(
               $"Unexpected token \"{reader.TokenType}\" when trying to deserialize \"ComplexValueObject<T1, T2, T3>\". Expected token: \"{(global::Newtonsoft.Json.JsonToken.StartObject)}\".",
               reader.Path,
               lineNumber,
               linePosition,
               null);
         }

         T1? @property = default;
         T2? @nullableProperty = default;
         T3 @structProperty = default;
         T3? @nullableStructProperty = default;

         var comparer = global::System.StringComparer.OrdinalIgnoreCase;

         while (reader.Read())
         {
            if (reader.TokenType == global::Newtonsoft.Json.JsonToken.EndObject)
               break;

            if (reader.TokenType != global::Newtonsoft.Json.JsonToken.PropertyName)
            {
               var (lineNumber, linePosition) = GetLineInfo(reader);

               throw new global::Newtonsoft.Json.JsonReaderException(
                  $"Unexpected token \"{reader.TokenType}\" when trying to deserialize \"ComplexValueObject<T1, T2, T3>\". Expected token: \"{(global::Newtonsoft.Json.JsonToken.PropertyName)}\".",
                  reader.Path,
                  lineNumber,
                  linePosition,
                  null);
            }

            var propName = reader.Value!.ToString();

            if(!reader.Read())
            {
               var (lineNumber, linePosition) = GetLineInfo(reader);

               throw new global::Newtonsoft.Json.JsonReaderException(
                  $"Unexpected end of the JSON message when trying the read the value of \"{propName}\" during deserialization of \"ComplexValueObject<T1, T2, T3>\".",
                  reader.Path,
                  lineNumber,
                  linePosition,
                  null);
            }

            if (comparer.Equals(propName, "property"))
            {
               @property = serializer.Deserialize<T1>(reader);
            }
            else if (comparer.Equals(propName, "nullableProperty"))
            {
               @nullableProperty = serializer.Deserialize<T2?>(reader);
            }
            else if (comparer.Equals(propName, "structProperty"))
            {
               @structProperty = serializer.Deserialize<T3>(reader);
            }
            else if (comparer.Equals(propName, "nullableStructProperty"))
            {
               @nullableStructProperty = serializer.Deserialize<T3?>(reader);
            }
            else
            {
               var (lineNumber, linePosition) = GetLineInfo(reader);

               throw new global::Newtonsoft.Json.JsonReaderException(
                  $"Unknown member \"{propName}\" encountered when trying to deserialize \"ComplexValueObject<T1, T2, T3>\".",
                  reader.Path,
                  lineNumber,
                  linePosition,
                  null);
            }
         }

         var validationError = global::Thinktecture.Tests.ComplexValueObject<T1, T2, T3>.Validate(
                                    @property!,
                                    @nullableProperty!,
                                    @structProperty!,
                                    @nullableStructProperty!,
                                    out var obj);

         if (validationError is not null)
         {
            var (lineNumber, linePosition) = GetLineInfo(reader);

            throw new global::Newtonsoft.Json.JsonSerializationException(
               validationError.ToString() ?? "Unable to deserialize \"ComplexValueObject<T1, T2, T3>\".",
               reader.Path,
               lineNumber,
               linePosition,
               null);
         }

         return obj;
      }

      /// <inheritdoc />
      public override void WriteJson(global::Newtonsoft.Json.JsonWriter writer, object? value, global::Newtonsoft.Json.JsonSerializer serializer)
      {
         if (value is null)
         {
            writer.WriteNull();
            return;
         }

         var obj = (global::Thinktecture.Tests.ComplexValueObject<T1, T2, T3>)value;
         var resolver = serializer.ContractResolver as global::Newtonsoft.Json.Serialization.DefaultContractResolver;

         writer.WriteStartObject();
         var @propertyPropertyValue = obj.Property;

         if(serializer.NullValueHandling != global::Newtonsoft.Json.NullValueHandling.Ignore || @propertyPropertyValue is not null)
         {
            writer.WritePropertyName((resolver != null) ? resolver.GetResolvedPropertyName("Property") : "Property");
            serializer.Serialize(writer, @propertyPropertyValue);
         }
         var @nullablePropertyPropertyValue = obj.NullableProperty;

         if(serializer.NullValueHandling != global::Newtonsoft.Json.NullValueHandling.Ignore || @nullablePropertyPropertyValue is not null)
         {
            writer.WritePropertyName((resolver != null) ? resolver.GetResolvedPropertyName("NullableProperty") : "NullableProperty");
            serializer.Serialize(writer, @nullablePropertyPropertyValue);
         }
         var @structPropertyPropertyValue = obj.StructProperty;

         writer.WritePropertyName((resolver != null) ? resolver.GetResolvedPropertyName("StructProperty") : "StructProperty");
         serializer.Serialize(writer, @structPropertyPropertyValue);
         var @nullableStructPropertyPropertyValue = obj.NullableStructProperty;

         if(serializer.NullValueHandling != global::Newtonsoft.Json.NullValueHandling.Ignore || @nullableStructPropertyPropertyValue is not null)
         {
            writer.WritePropertyName((resolver != null) ? resolver.GetResolvedPropertyName("NullableStructProperty") : "NullableStructProperty");
            serializer.Serialize(writer, @nullableStructPropertyPropertyValue);
         }
         writer.WriteEndObject();
      }

      private static (int Number, int Position) GetLineInfo(global::Newtonsoft.Json.JsonReader reader)
      {
         var lineInfo = (reader as global::Newtonsoft.Json.IJsonLineInfo);

         if (lineInfo?.HasLineInfo() == true)
         {
            return (lineInfo.LineNumber, lineInfo.LinePosition);
         }
         else
         {
            return (0, 0);
         }
      }
   }
}

file class ValueObjectNewtonsoftJsonConverterFactory : global::Newtonsoft.Json.JsonConverter
{
   private static readonly global::System.Collections.Concurrent.ConcurrentDictionary<global::System.Type, global::Newtonsoft.Json.JsonConverter> _converterByType = new();

   public override bool CanConvert(global::System.Type objectType)
   {
      objectType = global::System.Nullable.GetUnderlyingType(objectType) ?? objectType;

      if (!objectType.IsGenericType || objectType.IsGenericTypeDefinition)
         return false;

      return typeof(global::Thinktecture.Tests.ComplexValueObject<,,>) == objectType.GetGenericTypeDefinition();
   }

   public override object? ReadJson(global::Newtonsoft.Json.JsonReader reader, global::System.Type objectType, object? existingValue, global::Newtonsoft.Json.JsonSerializer serializer)
   {
      return _converterByType.GetOrAdd(objectType, CreateConverter).ReadJson(reader, objectType, existingValue, serializer);
   }

   public override void WriteJson(global::Newtonsoft.Json.JsonWriter writer, object? value, global::Newtonsoft.Json.JsonSerializer serializer)
   {
      if (value is null)
      {
         writer.WriteNull();
      }
      else
      {
         _converterByType.GetOrAdd(value.GetType(), CreateConverter).WriteJson(writer, value, serializer);
      }
   }

   private static global::Newtonsoft.Json.JsonConverter CreateConverter(global::System.Type objectType)
   {
      if (objectType is null)
         throw new global::System.ArgumentNullException(nameof(objectType));

      objectType = global::System.Nullable.GetUnderlyingType(objectType) ?? objectType;

      var converterType = objectType.GetNestedType("ValueObjectNewtonsoftJsonConverter")
         ?? throw new global::System.Exception("Implementation of the json converter for the complex value object \"global::Thinktecture.Tests.ComplexValueObject<T1, T2, T3>\" not found.");

      converterType = converterType.MakeGenericType(objectType.GenericTypeArguments);

      return (global::Newtonsoft.Json.JsonConverter?)global::System.Activator.CreateInstance(converterType)
         ?? throw new global::System.Exception($"Could not create an instance of json converter of type \"{converterType.FullName}\".");
   }
}
